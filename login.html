<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDdwnrO8RKn1ER5J3pyFbr69P9GjvR7CZ8",
    authDomain: "reviewresq-app.firebaseapp.com",
    projectId: "reviewresq-app",
    storageBucket: "reviewresq-app.firebasestorage.app",
    messagingSenderId: "863497920392",
    appId: "1:863497920392:web:ca99060b42a50711b9e43d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI elements
  const tabLogin = document.getElementById("tab-login");
  const tabSignup = document.getElementById("tab-signup");
  const loginForm = document.getElementById("loginForm");
  const signupForm = document.getElementById("signupForm");
  const resetForm = document.getElementById("resetForm");
  const forgotLink = document.getElementById("forgotLink");

  const loginError = document.getElementById("loginError");
  const signupError = document.getElementById("signupError");
  const resetMessage = document.getElementById("resetMessage");

  // Switch tabs
  function showTab(tab) {
    if (tab === "login") {
      tabLogin.classList.add("active");
      tabSignup.classList.remove("active");
      loginForm.classList.add("active");
      signupForm.classList.remove("active");
    } else {
      tabSignup.classList.add("active");
      tabLogin.classList.remove("active");
      signupForm.classList.add("active");
      loginForm.classList.remove("active");
    }
    loginError.textContent = "";
    signupError.textContent = "";
    resetMessage.textContent = "";
    resetForm.style.display = "none";
  }

  tabLogin.addEventListener("click", () => showTab("login"));
  tabSignup.addEventListener("click", () => showTab("signup"));

  // LOGIN
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    loginError.textContent = "";

    const email = loginEmail.value.trim();
    const password = loginPassword.value;

    try {
      await signInWithEmailAndPassword(auth, email, password);
      window.location.href = "/dashboard";
    } catch (err) {
      console.error(err);
      if (err.code === "auth/invalid-email") loginError.textContent = "Invalid email format.";
      else if (err.code === "auth/user-not-found") loginError.textContent = "Account not found.";
      else if (err.code === "auth/wrong-password") loginError.textContent = "Wrong password.";
      else loginError.textContent = "Login failed.";
    }
  });

  // VALIDATIONS
  function isValidPhone(phone) {
    return /^[0-9\-+() ]{7,15}$/.test(phone);
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  // SIGNUP
  signupForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    signupError.textContent = "";

    const businessName = signupBusinessName.value.trim();
    const phone = signupPhone.value.trim();
    const email = signupEmail.value.trim();
    const password = signupPassword.value;

    // VALIDATIONS
    if (!businessName) {
      signupError.textContent = "Business name is required.";
      return;
    }
    if (!isValidPhone(phone)) {
      signupError.textContent = "Enter a valid phone number.";
      return;
    }
    if (!isValidEmail(email)) {
      signupError.textContent = "Enter a valid email.";
      return;
    }
    if (password.length < 6) {
      signupError.textContent = "Password must be at least 6 characters.";
      return;
    }

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const uid = cred.user.uid;

      await setDoc(doc(db, "businesses", uid), {
        businessName,
        email,
        phone,
        plan: "advanced",
        createdAt: new Date().toISOString(),
        reviews: []
      });

      window.location.href = "/dashboard";
    } catch (err) {
      console.error(err);
      if (err.code === "auth/email-already-in-use")
        signupError.textContent = "This email is already registered.";
      else if (err.code === "auth/invalid-email")
        signupError.textContent = "Invalid email format.";
      else if (err.code === "auth/weak-password")
        signupError.textContent = "Password is too weak.";
      else signupError.textContent = "Could not create account.";
    }
  });

  // FORGOT PASSWORD
  forgotLink.addEventListener("click", () => {
    resetForm.style.display = "block";
    resetMessage.textContent = "";
    const emailFromLogin = loginEmail.value.trim();
    if (emailFromLogin) resetEmail.value = emailFromLogin;
  });

  resetForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    resetMessage.textContent = "";

    const email = resetEmail.value.trim();
    if (!isValidEmail(email)) {
      resetMessage.textContent = "Enter a valid email address.";
      return;
    }

    try {
      await sendPasswordResetEmail(auth, email);
      resetMessage.textContent = "Reset link sent â€” check your inbox.";
    } catch (err) {
      console.error(err);
      if (err.code === "auth/user-not-found") {
        resetMessage.textContent = "No account with this email.";
      } else {
        resetMessage.textContent = "Could not send reset email.";
      }
    }
  });
</script>
