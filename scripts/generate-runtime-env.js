const fs = require("fs");
const path = require("path");
const projectRoot = path.resolve(__dirname, "..");
const envPath = path.join(projectRoot, ".env");

function loadEnvFromFile(filePath) {
  if (!fs.existsSync(filePath)) {
    return {};
  }

  return fs
    .readFileSync(filePath, "utf8")
    .split(/\r?\n/)
    .reduce((acc, line) => {
      const trimmed = line.trim();
      if (!trimmed || trimmed.startsWith("#")) return acc;

      const [key, ...rest] = trimmed.split("=");
      const value = rest.join("=").trim();
      acc[key] = value;
      return acc;
    }, {});
}

const fileEnv = loadEnvFromFile(envPath);
const mergedEnv = { ...fileEnv, ...process.env };

const fallbackConfig = {
  FIREBASE_AUTH_DOMAIN: "reviewresq-app.firebaseapp.com",
  FIREBASE_PROJECT_ID: "reviewresq-app",
  FIREBASE_STORAGE_BUCKET: "reviewresq-app.appspot.com",
  FIREBASE_MESSAGING_SENDER_ID: "863497920392",
  FIREBASE_APP_ID: "1:863497920392:web:ca99060b42a50711b9e43d",
  FIREBASE_MEASUREMENT_ID: "G-G3P2BX845N",
};

const runtimeEnv = {
  FIREBASE_API_KEY: mergedEnv.FIREBASE_API_KEY || "",
  FIREBASE_AUTH_DOMAIN:
    mergedEnv.FIREBASE_AUTH_DOMAIN || fallbackConfig.FIREBASE_AUTH_DOMAIN,
  FIREBASE_PROJECT_ID:
    mergedEnv.FIREBASE_PROJECT_ID || fallbackConfig.FIREBASE_PROJECT_ID,
  FIREBASE_STORAGE_BUCKET:
    mergedEnv.FIREBASE_STORAGE_BUCKET || fallbackConfig.FIREBASE_STORAGE_BUCKET,
  FIREBASE_MESSAGING_SENDER_ID:
    mergedEnv.FIREBASE_MESSAGING_SENDER_ID || fallbackConfig.FIREBASE_MESSAGING_SENDER_ID,
  FIREBASE_APP_ID:
    mergedEnv.FIREBASE_APP_ID || fallbackConfig.FIREBASE_APP_ID,
  FIREBASE_MEASUREMENT_ID:
    mergedEnv.FIREBASE_MEASUREMENT_ID || fallbackConfig.FIREBASE_MEASUREMENT_ID,
  GOOGLE_MAPS_API_KEY: mergedEnv.GOOGLE_MAPS_API_KEY || "",
};

const required = ["FIREBASE_API_KEY"];
const missing = required.filter((key) => !runtimeEnv[key]);

if (missing.length) {
  console.error(
    `Missing required environment variables: ${missing.join(", ")}. Add them to .env or export them before running the build.`
  );
  process.exit(1);
}

const banner = `// This file is auto-generated by scripts/generate-runtime-env.js.\n// Do not commit this file to version control.\n`;
const output = `${banner}export const runtimeEnv = ${JSON.stringify(
  runtimeEnv,
  null,
  2
)};\n`;

const outputPath = path.join(projectRoot, "runtime-env.js");
fs.writeFileSync(outputPath, output, "utf8");
console.log(`runtime-env.js generated at ${outputPath}`);
