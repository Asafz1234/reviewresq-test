const fs = require("fs");
const path = require("path");
const projectRoot = path.resolve(__dirname, "..");
const envPath = path.join(projectRoot, ".env");

function loadEnvFromFile(filePath) {
  if (!fs.existsSync(filePath)) {
    return {};
  }

  return fs
    .readFileSync(filePath, "utf8")
    .split(/\r?\n/)
    .reduce((acc, line) => {
      const trimmed = line.trim();
      if (!trimmed || trimmed.startsWith("#")) return acc;

      const [key, ...rest] = trimmed.split("=");
      const value = rest.join("=").trim();
      acc[key] = value;
      return acc;
    }, {});
}

const fileEnv = loadEnvFromFile(envPath);
const mergedEnv = { ...fileEnv, ...process.env };

const defaultEnv = {
  FIREBASE_API_KEY: "AIzaSyDdwnrO8RKn1ER5J3pyFbr69P9GjvR7CZ8",
  FIREBASE_AUTH_DOMAIN: "reviewresq-app.firebaseapp.com",
  FIREBASE_PROJECT_ID: "reviewresq-app",
  FIREBASE_STORAGE_BUCKET: "reviewresq-app.appspot.com",
  FIREBASE_MESSAGING_SENDER_ID: "863497920392",
  FIREBASE_APP_ID: "1:863497920392:web:ca99060b42a50711b9e43d",
  FIREBASE_MEASUREMENT_ID: "G-G3P2BX845N",
  GOOGLE_MAPS_API_KEY: "AIzaSyDdwnrO8RKn1ER5J3pyFbr69P9GjvR7CZ8",
  GOOGLE_OAUTH_SCOPES: "https://www.googleapis.com/auth/business.manage",
};

const runtimeEnv = {
  ...defaultEnv,
  FIREBASE_API_KEY: mergedEnv.FIREBASE_API_KEY || defaultEnv.FIREBASE_API_KEY,
  FIREBASE_AUTH_DOMAIN:
    mergedEnv.FIREBASE_AUTH_DOMAIN || defaultEnv.FIREBASE_AUTH_DOMAIN,
  FIREBASE_PROJECT_ID:
    mergedEnv.FIREBASE_PROJECT_ID || defaultEnv.FIREBASE_PROJECT_ID,
  FIREBASE_STORAGE_BUCKET:
    mergedEnv.FIREBASE_STORAGE_BUCKET || defaultEnv.FIREBASE_STORAGE_BUCKET,
  FIREBASE_MESSAGING_SENDER_ID:
    mergedEnv.FIREBASE_MESSAGING_SENDER_ID || defaultEnv.FIREBASE_MESSAGING_SENDER_ID,
  FIREBASE_APP_ID: mergedEnv.FIREBASE_APP_ID || defaultEnv.FIREBASE_APP_ID,
  FIREBASE_MEASUREMENT_ID:
    mergedEnv.FIREBASE_MEASUREMENT_ID || defaultEnv.FIREBASE_MEASUREMENT_ID,
  GOOGLE_MAPS_API_KEY:
    mergedEnv.GOOGLE_MAPS_API_KEY || defaultEnv.GOOGLE_MAPS_API_KEY,
  GOOGLE_OAUTH_CLIENT_ID: mergedEnv.GOOGLE_OAUTH_CLIENT_ID || "",
  GOOGLE_OAUTH_REDIRECT_URI: mergedEnv.GOOGLE_OAUTH_REDIRECT_URI || "",
  GOOGLE_OAUTH_SCOPES: mergedEnv.GOOGLE_OAUTH_SCOPES || defaultEnv.GOOGLE_OAUTH_SCOPES,
};

const banner = `// This file is auto-generated by scripts/generate-runtime-env.js.\n`;
const runtimeEnvScript = `${banner}window.RUNTIME_ENV = ${JSON.stringify(
  runtimeEnv,
  null,
  2
)};\n`;

const outputPath = path.join(projectRoot, "runtime-env.js");
fs.writeFileSync(outputPath, runtimeEnvScript, "utf8");
console.log(`runtime-env.js generated at ${outputPath}`);
