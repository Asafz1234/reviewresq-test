rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Public business profile data for the feedback portal
    match /businessProfiles/{businessId} {
      allow get, list: if true;

      match /feedback/{feedbackId} {
        allow create: if true;

        // No public reads/updates/deletes for feedback documents
        allow read, update, delete: if false;
      }
    }

    // Portal appearance/settings (no private data)
    match /portalSettings/{businessId} {
      allow get, list: if true;
    }

    match /businesses/{businessId} {
      allow get, list: if request.auth != null && request.auth.uid == businessId;

      match /settings/{settingId} {
        allow get, list: if request.auth != null && request.auth.uid == businessId;
        // Review funnel settings must be updated via Cloud Functions to enforce plan rules
        allow create, update, delete: if false;
      }
    }

    // Public feedback from the customer portal
    match /feedback/{document} {
      allow create: if
        // allow anonymous (no auth required)
        true
        &&
        // basic validation on fields
        request.resource.data.rating is int &&
        request.resource.data.rating >= 1 &&
        request.resource.data.rating <= 5 &&
        request.resource.data.businessId is string &&
        request.resource.data.businessId.size() > 0 &&
        request.resource.data.type == "private" &&
        request.resource.data.source == "portal";

      // Do NOT allow public reads of feedback
      allow read: if false;
    }

    // keep all the existing rules for the rest of the collections here
    // (do not remove or relax any existing admin/business rules)
  }
}
