<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ReviewResQ – Google Reviews</title>
  <link
    rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%232563eb'/%3E%3Ctext x='32' y='42' font-size='32' text-anchor='middle' fill='white' font-family='Inter,%20Arial,%20sans-serif'%3ERR%3C/text%3E%3C/svg%3E"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="dashboard-modern.css" />
</head>
<body>
  <div class="page-shell">
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand-mark">RR</div>
        <div class="brand-name">ReviewResQ</div>
      </div>
      <div class="topbar-center">Google Reviews</div>
      <div class="topbar-right">
        <span class="plan-chip">Advanced plan</span>
        <div class="profile">RQ</div>
      </div>
    </header>

    <nav class="global-nav" aria-label="Dashboard sections">
      <div class="nav-tabs">
        <a class="nav-tab" data-route="overview" href="dashboard.html#overview">Overview</a>
        <a class="nav-tab" data-route="inbox" href="inbox.html">Inbox</a>
        <a class="nav-tab" data-route="google-reviews" href="google-reviews.html">Google Reviews</a>
        <a class="nav-tab" data-route="leads" href="leads.html">Leads</a>
        <a class="nav-tab" data-route="ai-agent" href="ai-agent/index.html">AI Agent</a>
        <a class="nav-tab" data-route="follow-ups" href="follow-ups.html">Follow-ups</a>
        <a class="nav-tab" data-route="automations" href="automations.html">Automations</a>
        <a class="nav-tab" data-route="settings" href="settings.html">Alerts &amp; Settings</a>
      </div>
    </nav>

    <main class="page-container" id="google-reviews">
      <header class="section">
        <div class="section-header">
          <div>
            <h1 class="page-title">Google Reviews</h1>
            <p class="page-subtitle">Manage your Google reviews and AI replies in one place.</p>
          </div>
          <div class="button-row">
            <button class="btn btn-secondary" id="syncReviewsBtn">Sync reviews</button>
            <button class="btn btn-primary">Connect Google Business</button>
          </div>
        </div>
      </header>

      <section class="section">
        <div class="card">
          <div class="filters-row">
            <label class="filter-field">
              <span class="card-title">Status</span>
              <select class="select" id="statusFilter">
                <option value="all">All</option>
                <option value="needs">Needs reply</option>
                <option value="auto">Auto replied</option>
                <option value="manual">Replied manually</option>
                <option value="failed">Failed</option>
              </select>
            </label>
            <label class="filter-field">
              <span class="card-title">Rating</span>
              <select class="select" id="ratingFilter">
                <option value="all">All</option>
                <option value="5">5★</option>
                <option value="4">4★</option>
                <option value="3">3★</option>
                <option value="2">2★</option>
                <option value="1">1★</option>
              </select>
            </label>
            <label class="filter-field fill">
              <span class="card-title">Search</span>
              <input class="input" id="searchFilter" type="search" placeholder="Search by reviewer or text" />
            </label>
          </div>
        </div>
      </section>

      <section class="section" id="reviewsSection">
        <div class="card" id="emptyState" style="display:none;">
          <h3 class="section-title">No Google reviews fetched yet</h3>
          <p class="card-sub">Connect your Google Business account and click Sync reviews.</p>
        </div>
        <div class="review-list" id="reviewList"></div>
      </section>
    </main>
  </div>

  <template id="review-row-template">
    <article class="card review-row">
      <div class="review-meta">
        <div class="reviewer">Alex Doe</div>
        <div class="rating-row">
          <span class="stars">★★★★★</span>
          <span class="caption">Mar 28, 2025 · Google</span>
        </div>
      </div>
      <div class="review-body">
        <p class="review-text">Great service and quick turnaround.</p>
        <p class="reply-text">Owner reply: Thanks for choosing us!</p>
      </div>
      <div class="review-actions">
        <span class="badge" data-role="status-badge">Needs reply</span>
        <div class="button-row" data-role="action-buttons"></div>
      </div>
    </article>
  </template>

  <script src="dashboard-nav.js"></script>
  <script>
    const reviews = [
      {
        businessId: 'biz-1',
        reviewId: 'r1',
        reviewerName: 'Alex Doe',
        rating: 5,
        text: 'Fantastic work on our kitchen remodel. The team was prompt and respectful.',
        language: 'en',
        createdAt: '2025-03-28',
        replyStatus: 'auto_sent',
        replyText: 'Thank you so much, Alex! We loved working on your kitchen and are here if you need anything else.',
        replySource: 'ai_auto',
        sentimentScore: 0.92,
      },
      {
        businessId: 'biz-1',
        reviewId: 'r2',
        reviewerName: 'Maria Alvarez',
        rating: 2,
        text: 'The technician arrived late and the fix didn\'t last. Not happy.',
        language: 'en',
        createdAt: '2025-03-26',
        replyStatus: 'draft',
        replyText: 'Hi Maria, we\'re sorry about the delay and the issue. We can send a technician today to make this right.',
        replySource: 'ai_auto',
        sentimentScore: -0.6,
        needsAttention: true,
      },
      {
        businessId: 'biz-1',
        reviewId: 'r3',
        reviewerName: 'Chen Li',
        rating: 4,
        text: 'Good experience overall. Scheduling could be smoother next time.',
        language: 'en',
        createdAt: '2025-03-22',
        replyStatus: 'none',
        replyText: '',
        replySource: 'ai_manual',
        sentimentScore: 0.25,
      },
      {
        businessId: 'biz-1',
        reviewId: 'r4',
        reviewerName: 'Jordan Smith',
        rating: 1,
        text: 'The repair failed twice. Please call me back.',
        language: 'en',
        createdAt: '2025-03-20',
        replyStatus: 'failed',
        replyText: '',
        replySource: '',
        sentimentScore: -0.8,
        needsAttention: true,
      },
    ];

    const statusMap = {
      none: { label: 'Needs reply', tone: 'badge-warning' },
      draft: { label: 'Draft pending', tone: 'badge-muted' },
      auto_sent: { label: 'Auto replied', tone: 'badge-success' },
      manual_sent: { label: 'Replied manually', tone: 'badge' },
      failed: { label: 'Failed', tone: 'badge-danger' },
    };

    const statusFilter = document.getElementById('statusFilter');
    const ratingFilter = document.getElementById('ratingFilter');
    const searchFilter = document.getElementById('searchFilter');
    const reviewList = document.getElementById('reviewList');
    const emptyState = document.getElementById('emptyState');

    function formatStars(rating) {
      return '★★★★★'.slice(0, rating) + '☆☆☆☆☆'.slice(rating).slice(0, 5 - rating);
    }

    function renderReviews() {
      reviewList.innerHTML = '';

      const filtered = reviews.filter((review) => {
        const statusValue = statusFilter.value;
        const ratingValue = ratingFilter.value;
        const searchValue = searchFilter.value.toLowerCase();

        const matchesStatus =
          statusValue === 'all' ||
          (statusValue === 'needs' && (review.replyStatus === 'none' || review.needsAttention)) ||
          (statusValue === 'auto' && review.replySource === 'ai_auto') ||
          (statusValue === 'manual' && (review.replySource === 'ai_manual' || review.replySource === 'user_manual')) ||
          (statusValue === 'failed' && review.replyStatus === 'failed');

        const matchesRating = ratingValue === 'all' || review.rating === Number(ratingValue);
        const matchesSearch =
          !searchValue ||
          review.reviewerName.toLowerCase().includes(searchValue) ||
          review.text.toLowerCase().includes(searchValue) ||
          review.replyText.toLowerCase().includes(searchValue);

        return matchesStatus && matchesRating && matchesSearch;
      });

      emptyState.style.display = filtered.length === 0 ? 'block' : 'none';

      filtered.forEach((review) => {
        const tpl = document.getElementById('review-row-template');
        const node = tpl.content.cloneNode(true);
        node.querySelector('.reviewer').textContent = review.reviewerName;
        node.querySelector('.stars').textContent = formatStars(review.rating);
        node.querySelector('.caption').textContent = `${review.createdAt} · Google`;
        node.querySelector('.review-text').textContent = review.text;

        const status = statusMap[review.replyStatus] || statusMap.none;
        const badge = node.querySelector('[data-role="status-badge"]');
        badge.textContent = review.needsAttention ? 'Needs attention' : status.label;
        badge.className = `badge ${status.tone}`;

        const replyTextEl = node.querySelector('.reply-text');
        if (review.replyText) {
          replyTextEl.textContent = `${review.replyStatus === 'draft' ? 'Draft: ' : 'Reply:'} ${review.replyText}`;
        } else {
          replyTextEl.style.display = 'none';
        }

        const actions = node.querySelector('[data-role="action-buttons"]');
        actions.append(...buildActions(review));
        reviewList.appendChild(node);
      });
    }

    function buildActions(review) {
      const buttons = [];

      const button = (label, variant, handler) => {
        const btn = document.createElement('button');
        btn.className = `btn ${variant}`;
        btn.textContent = label;
        btn.addEventListener('click', handler);
        return btn;
      };

      if (review.replyStatus === 'none') {
        buttons.push(button('Generate reply', 'btn-secondary', () => generateDraft(review)));
      } else if (review.replyStatus === 'draft') {
        buttons.push(button('Approve & Send', 'btn-primary', () => approveAndSend(review)));
        buttons.push(button('Regenerate', 'btn-secondary', () => generateDraft(review, true)));
      } else if (review.replyStatus === 'auto_sent' || review.replyStatus === 'manual_sent') {
        buttons.push(button('View reply', 'btn-secondary', () => showToast('Reply already sent')));
        buttons.push(button('Edit reply', 'btn-secondary', () => generateDraft(review, true)));
      }

      if (review.replyStatus === 'failed') {
        buttons.push(button('Retry sending', 'btn-primary', () => approveAndSend(review)));
      }

      return buttons;
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => toast.remove(), 2600);
    }

    function generateDraft(review, regenerate = false) {
      review.replyStatus = 'draft';
      review.replySource = 'ai_manual';
      review.replyText = regenerate
        ? 'Updated AI draft ready for your review.'
        : 'Thanks for sharing your feedback! We appreciate the opportunity to help again.';
      review.needsAttention = review.rating <= 3;
      showToast('Generating reply…');
      setTimeout(renderReviews, 200);
    }

    function approveAndSend(review) {
      review.replyStatus = 'auto_sent';
      review.replySource = 'ai_auto';
      review.needsAttention = false;
      showToast('Reply sent to Google');
      renderReviews();
    }

    statusFilter.addEventListener('change', renderReviews);
    ratingFilter.addEventListener('change', renderReviews);
    searchFilter.addEventListener('input', renderReviews);
    document.getElementById('syncReviewsBtn').addEventListener('click', () =>
      showToast('Syncing Google reviews…')
    );

    renderReviews();
  </script>
</body>
</html>
