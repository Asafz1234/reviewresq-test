<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Business Profile â€“ ReviewResQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%232563eb'/%3E%3Ctext x='32' y='42' font-size='32' text-anchor='middle' fill='white' font-family='Inter,%20Arial,%20sans-serif'%3ERR%3C/text%3E%3C/svg%3E"
  />
  <link rel="stylesheet" href="styles.css" />
  <script src="/runtime-env.js"></script>
  <script type="module" src="/firebase-config.js"></script>
</head>

<body>
  <div class="container">
    <h2>Business Profile</h2>
    <p>Update your business information so customers see your brand correctly.</p>

    <form id="businessForm">

      <label>Business Name</label>
      <input type="text" id="bizName" placeholder="My Company LLC" required />

      <label>Business Email</label>
      <input type="email" id="bizEmail" placeholder="company@example.com" required />

      <label>Phone Number</label>
      <input type="text" id="bizPhone" placeholder="+1 555 555 5555" required />

      <label>Business Address</label>
      <input type="text" id="bizAddress" placeholder="123 Main St, Florida" />

      <label>Google Review Link</label>
      <input type="text" id="googleLink" placeholder="https://g.page/r/xxxxx" />

      <label>Primary Brand Color</label>
      <input type="color" id="primaryColor" value="#2563eb" />

      <label>Secondary Brand Color</label>
      <input type="color" id="secondaryColor" value="#facc15" />

      <label>Upload Logo</label>
      <input type="file" id="logoUpload" accept="image/*" />

      <button type="submit" class="saveBtn">Save Changes</button>
    </form>

    <p id="statusMsg"></p>
  </div>

  <script type="module">
    import {
      db,
      auth,
      uploadLogoAndGetURL,
      doc,
      getDoc,
      setDoc,
    } from "./firebase-config.js";

    async function ensureCanonicalBrandFields(ref, data = {}) {
      const updates = {};

      if (!data.businessName && (data.displayName || data.name)) {
        updates.businessName = data.displayName || data.name || "";
      }

      if (!data.logoUrl) {
        const legacyLogo =
          data.brandLogoUrl ||
          data.businessLogoUrl ||
          data.logoDataUrl ||
          data.logoURL ||
          null;

        if (legacyLogo) {
          updates.logoUrl = legacyLogo;
        }
      }

      if (Object.keys(updates).length) {
        await setDoc(ref, updates, { merge: true });
      }
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const ref = doc(db, "businesses", user.uid);
      const snap = await getDoc(ref);

      if (snap.exists()) {
        const data = snap.data();

        await ensureCanonicalBrandFields(ref, data);

        bizName.value = data.businessName || data.displayName || data.name || "";
        bizEmail.value = data.email || "";
        bizPhone.value = data.phone || "";
        bizAddress.value = data.address || "";
        googleLink.value = data.googleReviewUrl || data.googleLink || "";
        primaryColor.value = data.branding?.primary || data.brandColor || "#2563eb";
        secondaryColor.value = data.branding?.secondary || "#facc15";
      }

      businessForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        let logoUploadResult = null;
        if (logoUpload.files.length > 0) {
          logoUploadResult = await uploadLogoAndGetURL(logoUpload.files[0], user.uid);
        }

        const payload = {
          businessName: bizName.value,
          displayName: bizName.value,
          name: bizName.value,
          email: bizEmail.value,
          phone: bizPhone.value,
          address: bizAddress.value,
          googleLink: googleLink.value,
          googleReviewUrl: googleLink.value,
          branding: {
            primary: primaryColor.value,
            secondary: secondaryColor.value,
            ...(logoUploadResult?.storagePath ? { logoPath: logoUploadResult.storagePath } : {})
          },
          ...(logoUploadResult?.url && {
            logoUrl: logoUploadResult.url,
            logoURL: logoUploadResult.url,
            brandLogoUrl: logoUploadResult.url,
            businessLogoUrl: logoUploadResult.url
          })
        };

        await setDoc(ref, payload, { merge: true });
        statusMsg.innerText = "Business profile updated successfully!";
      });
    });
  </script>

</body>
</html>
