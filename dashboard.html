<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - ReviewResQ</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="dashboard-page">
  <!-- TOP NAV BAR -->
  <header class="topbar">
    <div class="logo-area">
      <img src="logo.png" alt="ReviewResQ logo" class="logo" />
      <span class="brand">ReviewResQ</span>
    </div>

    <button
      class="logout-btn"
      onclick="localStorage.removeItem('businessId'); window.location.href='login.html';"
    >
      Logout
    </button>
  </header>

  <!-- MAIN LAYOUT -->
  <main class="dashboard-layout">
    <!-- SUMMARY PANEL -->
    <section class="summary-panel">
      <div class="summary-header">
        <h1>Your Reviews Dashboard</h1>
        <p class="business-name">
          Business: <span id="businessName">Loading...</span>
        </p>
      </div>

      <div class="metrics-grid">
        <div class="metric-card">
          <span class="metric-label">Total Reviews</span>
          <span class="metric-value" id="totalReviews">0</span>
        </div>

        <div class="metric-card">
          <span class="metric-label">Bad Reviews Rescued</span>
          <span class="metric-value" id="badRescued">0</span>
        </div>

        <div class="metric-card">
          <span class="metric-label">Monthly Growth</span>
          <span class="metric-value" id="monthlyGrowth">0%</span>
        </div>

        <div class="metric-card">
          <span class="metric-label">Review Invites Sent</span>
          <span class="metric-value" id="reviewInvites">0</span>
        </div>
      </div>
    </section>

    <!-- REVIEWS PANEL -->
    <section class="reviews-panel">
      <div class="panel-header">
        <h2>Customer Reviews</h2>
      </div>

      <div id="reviews" class="reviews-list">
        <!-- reviews injected here -->
      </div>
    </section>
  </main>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    console.log("Dashboard connected to Firestore");

    async function loadDashboard() {
      console.log("Loading dashboard...");

      const businessId = localStorage.getItem("businessId");
      if (!businessId) {
        window.location.href = "login.html";
        return;
      }

      const ref = doc(db, "businesses", businessId);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        document.getElementById("businessName").innerText = "Not found";
        return;
      }

      const data = snap.data();

      // business name
      document.getElementById("businessName").innerText =
        data.businessName || "Unknown";

      const reviews = data.reviews || [];

      // basic stats
      const total = reviews.length;
      const bad = reviews.filter(r => Number(r.rating) <= 3).length;

      document.getElementById("totalReviews").innerText = total;
      document.getElementById("badRescued").innerText = bad;
      document.getElementById("monthlyGrowth").innerText = "0%";
      document.getElementById("reviewInvites").innerText = "0";

      // render reviews
      const reviewsDiv = document.getElementById("reviews");
      reviewsDiv.innerHTML = "";

      if (!Array.isArray(reviews) || reviews.length === 0) {
        reviewsDiv.innerHTML = "<p class='empty-state'>No reviews yet.</p>";
        return;
      }

      reviews.forEach((r) => {
        const item = document.createElement("article");
        item.className = "reviewItem";
        item.innerHTML = `
          <div class="review-header">
            <div>
              <div class="reviewer-name">${r.reviewerName || "Customer"}</div>
              <div class="review-date">${r.date || ""}</div>
            </div>
            <div class="review-rating">‚≠ê ${r.rating || "-"}</div>
          </div>
          <p class="review-comment">${r.comment || ""}</p>
        `;
        reviewsDiv.appendChild(item);
      });
    }

    loadDashboard();
  </script>
</body>
</html>
