<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ReviewResQ – Google OAuth</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="icon" href="/logo.png" />
  <script src="/runtime-env.js"></script>
  <link rel="stylesheet" href="dashboard.css" />
</head>
<body>
  <div class="app-shell" style="padding:24px; max-width:620px; margin:0 auto;">
    <h1>Connecting your Google account…</h1>
    <p id="oauthStatus" class="card-subtitle">Completing secure connection. Please wait.</p>
    <div class="input-row" style="margin-top:24px;">
      <button id="retryBtn" class="btn btn-primary" type="button" style="display:none;">Try again</button>
    </div>
  </div>
  <script type="module">
    import { auth } from "./firebase-config.js";

    const statusEl = document.getElementById("oauthStatus");
    const retryBtn = document.getElementById("retryBtn");
    const params = new URLSearchParams(window.location.search || "");
    const code = params.get("code");
    const state = params.get("state");

    const functionsBaseUrl = window.__FUNCTIONS_BASE_URL || (window.RUNTIME_ENV && (window.RUNTIME_ENV.FUNCTIONS_BASE_URL || window.RUNTIME_ENV.GOOGLE_FUNCTIONS_BASE_URL)) ||
      "https://us-central1-reviewresq-app.cloudfunctions.net";

    function showError(message) {
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.style.color = "var(--danger, #b00020)";
      }
      if (retryBtn) retryBtn.style.display = "inline-flex";
    }

    async function exchangeCode() {
      if (!code || !state) {
        showError("Missing authorization details. Please try connecting again.");
        return;
      }
      try {
        if (statusEl) {
          statusEl.textContent = "Exchanging code with Google…";
          statusEl.style.color = "";
        }
        const user = auth.currentUser;
        if (!user) {
          showError("You must be signed in to finish connecting Google.");
          return;
        }
        const idToken = await user.getIdToken();
        const response = await fetch(`${functionsBaseUrl}/exchangeGoogleAuthCodeV2`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${idToken}`,
          },
          body: JSON.stringify({ code, state }),
        });
        if (!response.ok) {
          throw new Error("Unable to finish Google OAuth.");
        }
        const payload = await response.json();
        if (!payload?.ok) {
          throw new Error(payload?.message || "Unable to finish Google OAuth.");
        }
        const destination = payload?.returnTo || "/google-reviews.html";
        window.location.href = `${destination}?connected=1`;
      } catch (err) {
        console.error("[google-oauth] callback error", err);
        showError(err?.message || "Something went wrong connecting to Google.");
      }
    }

    retryBtn?.addEventListener("click", () => {
      window.location.href = "/google-reviews.html";
    });

    exchangeCode();
  </script>
</body>
</html>
