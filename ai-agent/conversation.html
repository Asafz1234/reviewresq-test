<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ReviewResQ ‚Äì AI Agent Conversation</title>
  <link
    rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%232563eb'/%3E%3Ctext x='32' y='42' font-size='32' text-anchor='middle' fill='white' font-family='Inter,%20Arial,%20sans-serif'%3ERR%3C/text%3E%3C/svg%3E"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/ai-agent/ai-agent.css" />
</head>
<body>
  <header class="topbar">
    <div class="topbar-left">
      <div class="brand-mark">RR</div>
      <div class="brand-name">ReviewResQ</div>
    </div>
    <div class="topbar-center">AI Agent</div>
    <div class="topbar-right">
      <a
        id="planBadge"
        class="plan-chip plan-chip--pro"
        href="../account.html"
        title="View and manage your subscription."
        >Pro AI Suite</a
      >
      <div class="profile">RQ</div>
    </div>
  </header>

  <nav class="global-nav" aria-label="Dashboard sections">
    <div class="nav-tabs">
      <a class="nav-tab" data-route="overview" href="../dashboard.html#overview">Overview</a>
      <a class="nav-tab" data-route="inbox" href="../inbox.html">Inbox</a>
      <a class="nav-tab" data-route="ai-agent" href="../ai-agent/index.html">AI Agent</a>
      <a class="nav-tab" data-route="follow-ups" href="../follow-ups.html">Follow-ups</a>
      <a class="nav-tab" data-route="automations" href="../automations.html">Automations</a>
      <a class="nav-tab" data-route="settings" href="../settings.html">Alerts &amp; Settings</a>
    </div>
  </nav>

  <div class="app-shell">
    <aside class="sidebar">
      <div class="branding">
        <div class="brand-mark">RR</div>
        <div>
          <h2>ReviewResQ</h2>
          <p>AI Agent Suite</p>
        </div>
      </div>
      <nav class="nav">
        <a href="/ai-agent/index.html">‚óÄ Back to conversations</a>
        <a href="/ai-agent/insights.html">üìä AI Insights</a>
        <a href="/settings/ai-agent.html">‚öôÔ∏è AI Settings</a>
      </nav>
    </aside>

    <main class="main">
      <div class="chat-shell">
        <header class="chat-header">
          <div class="chat-meta">
            <div class="brand-mark">ü§ñ</div>
            <div>
              <p class="badge info" id="conversationIdLabel">Conversation</p>
              <h2 id="customerName">Customer</h2>
              <div class="meta-row">
                <span class="status" id="statusLabel">Open</span>
                <span class="badge">Rating <strong id="ratingLabel">‚òÖ</strong></span>
                <span class="badge info">Sentiment <span id="sentimentLabel">-</span></span>
              </div>
            </div>
          </div>
          <button class="btn secondary" id="shareLink">Share AI transcript</button>
        </header>

        <section class="chat-window">
          <div class="chat-log" id="chatLog"></div>
          <div class="bubble ai" id="typingRow" aria-live="polite">
            <div class="typing" aria-label="AI is typing">
              <span></span><span></span><span></span>
            </div>
          </div>
        </section>

        <div class="chat-actions">
          <input id="messageInput" class="input" placeholder="Add a manual note or reply" />
          <button class="btn secondary" id="sendBtn">Send</button>
          <button class="btn" id="resolveBtn">Mark as resolved</button>
          <button class="btn secondary" id="reviewBtn">Send Google review link</button>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import {
      arrayUnion,
      db,
      doc,
      onSnapshot,
      serverTimestamp,
      updateDoc,
    } from "../firebase-config.js";

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    const chatLog = document.getElementById("chatLog");
    const typingRow = document.getElementById("typingRow");
    const customerNameEl = document.getElementById("customerName");
    const statusLabel = document.getElementById("statusLabel");
    const ratingLabel = document.getElementById("ratingLabel");
    const sentimentLabel = document.getElementById("sentimentLabel");
    const shareLink = document.getElementById("shareLink");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const resolveBtn = document.getElementById("resolveBtn");
    const reviewBtn = document.getElementById("reviewBtn");
    const conversationIdLabel = document.getElementById("conversationIdLabel");

    let currentConversation = null;

    function formatRating(rating) {
      return "‚òÖ".repeat(Math.max(1, Math.round(rating || 1)));
    }

    function renderChat(messages = []) {
      chatLog.innerHTML = "";
      messages
        .slice()
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
        .forEach((msg) => {
          const bubble = document.createElement("div");
          bubble.className = `bubble ${msg.sender === "ai" ? "ai" : "customer"}`;
          bubble.textContent = msg.message_text;
          chatLog.appendChild(bubble);
        });
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function hydrateHeader(data) {
      if (!data) return;
      customerNameEl.textContent = data.customerName || "Customer";
      statusLabel.textContent = data.status || "Open";
      ratingLabel.textContent = formatRating(data.rating);
      sentimentLabel.textContent = (data.sentiment || 0).toFixed(2);
      conversationIdLabel.textContent = `Conversation ‚Ä¢ ${id || ""}`;
    }

    function addLocalBubble(sender, text) {
      const bubble = document.createElement("div");
      bubble.className = `bubble ${sender === "ai" ? "ai" : "customer"}`;
      bubble.textContent = text;
      chatLog.appendChild(bubble);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    async function sendMessage() {
      const value = messageInput.value.trim();
      if (!value || !id) return;
      typingRow.style.display = "block";
      messageInput.value = "";
      addLocalBubble("customer", value);

      try {
        await fetch(
          "https://us-central1-reviewresq-app.cloudfunctions.net/aiAgentReply",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              conversationId: id,
              customerMessage: value,
            }),
          }
        );
      } catch (err) {
        console.error("Failed to send message", err);
        alert("Could not send the reply. Please try again.");
      } finally {
        typingRow.style.display = "none";
      }
    }

    async function markResolved() {
      if (!id) return;
      await updateDoc(doc(db, "ai_conversations", id), {
        status: "resolved",
        updatedAt: serverTimestamp(),
      });
    }

    async function sendReviewLink() {
      if (!id) return;
      const reviewMessage =
        "Thanks for working with us to fix things. If you're happy with the outcome, you can share a quick Google review: https://g.page/reviewresq";
      await updateDoc(doc(db, "ai_conversations", id), {
        messages: arrayUnion({
          sender: "ai",
          message_text: reviewMessage,
          timestamp: new Date().toISOString(),
        }),
        updatedAt: serverTimestamp(),
      });
    }

    sendBtn.addEventListener("click", sendMessage);
    resolveBtn.addEventListener("click", markResolved);
    reviewBtn.addEventListener("click", sendReviewLink);
    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    shareLink.addEventListener("click", () => {
      navigator.clipboard
        .writeText(window.location.href)
        .then(() => alert("Transcript link copied"))
        .catch(() => alert("Link ready: " + window.location.href));
    });

    if (id) {
      onSnapshot(doc(db, "ai_conversations", id), (snap) => {
        currentConversation = snap.data();
        if (!currentConversation) return;
        hydrateHeader(currentConversation);
        renderChat(currentConversation.messages || []);
      });
    } else {
      conversationIdLabel.textContent = "Conversation";
      chatLog.innerHTML =
        "<p class=\"empty-state\">No conversation selected. Please return to the AI Agent inbox.</p>";
    }

    typingRow.style.display = "none";
  </script>

  <script type="module" src="../topbar-menu.js"></script>
  <script src="../dashboard-nav.js"></script>
</body>
</html>
